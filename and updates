warning: in the working copy of 'README.md', LF will be replaced by CRLF the next time Git touches it
warning: in the working copy of 'src/handlers.py', LF will be replaced by CRLF the next time Git touches it
warning: in the working copy of 'src/main.py', LF will be replaced by CRLF the next time Git touches it
[1mdiff --git a/README.md b/README.md[m
[1mindex 9bdaaf9..6ea5b40 100644[m
[1m--- a/README.md[m
[1m+++ b/README.md[m
[36m@@ -8,6 +8,12 @@[m
 3) Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð±Ð¾Ñ‚Ð°:[m
    `python -m src.main`[m
 [m
[32m+[m[32m## ÐžÑ‚Ñ‡ÐµÑ‚Ð½Ð¾ÑÑ‚ÑŒ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ðµ (Ñ‚ÐµÐ¼Ñ‹)[m
[32m+[m[32m1) Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ "Ð¢ÐµÐ¼Ñ‹" (Ñ„Ð¾Ñ€ÑƒÐ¼) Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ðµ, Ð´Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð±Ð¾Ñ‚Ð° Ð¸ Ð´Ð°Ð¹Ñ‚Ðµ ÐµÐ¼Ñƒ Ð¿Ñ€Ð°Ð²Ð¾ Ð¿Ð¸ÑÐ°Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ.[m
[32m+[m[32m2) ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ñ‚ÐµÐ¼Ñƒ "Ð—Ð°Ð¿ÑƒÑÐºÐ¸" Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ: `/set_topic_starts`.[m
[32m+[m[32m3) ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ñ‚ÐµÐ¼Ñƒ "Ð¤Ð°Ð¹Ð»Ñ‹" Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ: `/set_topic_files`.[m
[32m+[m[32m4) ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°: Ð½Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð±Ð¾Ñ‚Ñƒ `/start` Ð² Ð›Ð¡ Ð¸ ÑÑ„Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ â€” Ð»Ð¾Ð³ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¿Ñ€Ð¸Ð¹Ñ‚Ð¸ Ð² "Ð—Ð°Ð¿ÑƒÑÐºÐ¸", PDF ÑƒÐ¹Ð´ÐµÑ‚ Ð² "Ð¤Ð°Ð¹Ð»Ñ‹".[m
[32m+[m
 ## Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð¸ ÑˆÐ°Ð±Ð»Ð¾Ð½Ñ‹[m
 - Ð¨Ð°Ð±Ð»Ð¾Ð½Ñ‹ Ð½Ð°Ñ…Ð¾Ð´ÑÑ‚ÑÑ Ð² `src/documents/templates/`.[m
 - Ð”Ð»Ñ PDF Ð½Ð° Windows Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¹ Microsoft Word (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ `docx2pdf`).[m
[1mdiff --git a/src/handlers.py b/src/handlers.py[m
[1mindex ecd9245..e41236a 100644[m
[1m--- a/src/handlers.py[m
[1m+++ b/src/handlers.py[m
[36m@@ -2,6 +2,7 @@[m
 from __future__ import annotations[m
 [m
 from datetime import datetime[m
[32m+[m[32mimport logging[m
 import html[m
 import re[m
 [m
[36m@@ -11,13 +12,18 @@[m [mfrom aiogram.fsm.context import FSMContext[m
 from aiogram.types import FSInputFile, KeyboardButton, Message, ReplyKeyboardMarkup[m
 [m
 try:[m
[32m+[m[32m    from .config import load_admin_user_ids, load_config, save_config[m
     from .documents.render import render_act, render_contract, render_supplement[m
[32m+[m[32m    from .reporting import send_doc_start_report, send_file_report, send_start_report[m
     from .states import ContractStates, SupplementStates[m
 except ImportError:  # pragma: no cover - allow running as script[m
[32m+[m[32m    from config import load_admin_user_ids, load_config, save_config[m
     from documents.render import render_act, render_contract, render_supplement[m
[32m+[m[32m    from reporting import send_doc_start_report, send_file_report, send_start_report[m
     from states import ContractStates, SupplementStates[m
 [m
 router = Router()[m
[32m+[m[32mlogger = logging.getLogger(__name__)[m
 [m
 MAIN_MENU_CONTRACT = "ðŸ“ Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€"[m
 MAIN_MENU_ACT = "ðŸ“„ ÐÐºÑ‚"[m
[36m@@ -55,6 +61,12 @@[m [mEDIT_CONTRACT_NUMBER = "ÐÐ¾Ð¼ÐµÑ€ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð°"[m
 EDIT_SUPPLEMENT_DATE = "Ð”Ð°Ñ‚Ð° Ð´Ð¾Ð¿. ÑÐ¾Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ñ"[m
 EDIT_SUPPLEMENT_TEXT = "Ð¢ÐµÐºÑÑ‚ Ð´Ð¾Ð¿. ÑÐ¾Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ñ"[m
 [m
[32m+[m[32mDOC_TYPE_LABELS = {[m
[32m+[m[32m    "contract": "Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€",[m
[32m+[m[32m    "act": "ÐÐºÑ‚",[m
[32m+[m[32m    "supplement": "Ð”Ð¾Ð¿. ÑÐ¾Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ðµ",[m
[32m+[m[32m}[m
[32m+[m
 [m
 def build_keyboard([m
     rows: list[list[str]],[m
[36m@@ -226,6 +238,59 @@[m [mdef state_from_value(state_value: str):[m
     return mapping.get(state_value)[m
 [m
 [m
[32m+[m[32mdef build_file_caption(data: dict, user) -> str:[m
[32m+[m[32m    doc_type = data.get("doc_type", "contract")[m
[32m+[m[32m    doc_label = DOC_TYPE_LABELS.get(doc_type, "Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚")[m
[32m+[m[32m    address = data.get("address") or "Ð½ÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…"[m
[32m+[m[32m    phone = data.get("phone") or "Ð½ÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…"[m
[32m+[m
[32m+[m[32m    client_name = data.get("client_name")[m
[32m+[m[32m    if not client_name:[m
[32m+[m[32m        client_name = "Ð½ÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…"[m
[32m+[m
[32m+[m[32m    username = f"@{user.username}" if getattr(user, "username", None) else "Ð½ÐµÑ‚ username"[m
[32m+[m
[32m+[m[32m    return ([m
[32m+[m[32m        f"ðŸ“„ {doc_label}\n"[m
[32m+[m[32m        f"ÐÐ´Ñ€ÐµÑ: {address}\n"[m
[32m+[m[32m        f"Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½: {phone}\n"[m
[32m+[m[32m        f"ÐšÐ»Ð¸ÐµÐ½Ñ‚: {client_name}\n"[m
[32m+[m[32m        f"Ð¡Ð´ÐµÐ»Ð°Ð» {doc_label.lower()}: {username}\n"[m
[32m+[m[32m        f"UserID: {user.id}"[m
[32m+[m[32m    )[m
[32m+[m
[32m+[m
[32m+[m[32masync def is_authorized_admin(message: Message) -> bool:[m
[32m+[m[32m    user = message.from_user[m
[32m+[m[32m    if user is None:[m
[32m+[m[32m        return False[m
[32m+[m
[32m+[m[32m    allowed_ids = load_admin_user_ids()[m
[32m+[m[32m    if allowed_ids and user.id in allowed_ids:[m
[32m+[m[32m        return True[m
[32m+[m
[32m+[m[32m    try:[m
[32m+[m[32m        member = await message.bot.get_chat_member(message.chat.id, user.id)[m
[32m+[m[32m    except Exception:  # noqa: BLE001 - external API[m
[32m+[m[32m        logger.exception("Failed to fetch chat member for admin check.")[m
[32m+[m[32m        return False[m
[32m+[m
[32m+[m[32m    return member.status in {"administrator", "creator"}[m
[32m+[m
[32m+[m
[32m+[m[32masync def ensure_topic_command(message: Message) -> bool:[m
[32m+[m[32m    if message.chat.type not in {"group", "supergroup"}:[m
[32m+[m[32m        await message.answer("ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ðµ/ÑÑƒÐ¿ÐµÑ€Ð³Ñ€ÑƒÐ¿Ð¿Ðµ.")[m
[32m+[m[32m        return False[m
[32m+[m[32m    if not message.message_thread_id:[m
[32m+[m[32m        await message.answer("ÐšÐ¾Ð¼Ð°Ð½Ð´Ñƒ Ð½ÑƒÐ¶Ð½Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ Ñ‚ÐµÐ¼Ñ‹ (Ñ„Ð¾Ñ€ÑƒÐ¼).")[m
[32m+[m[32m        return False[m
[32m+[m[32m    if not await is_authorized_admin(message):[m
[32m+[m[32m        await message.answer("ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¿Ñ€Ð°Ð² Ð´Ð»Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸.")[m
[32m+[m[32m        return False[m
[32m+[m[32m    return True[m
[32m+[m
[32m+[m
 async def prompt_for_state(message: Message, state_value: str, data: dict) -> None:[m
     if state_value == ContractStates.waiting_for_client_name.state:[m
         await message.answer("Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¤Ð˜Ðž Ð·Ð°ÐºÐ°Ð·Ñ‡Ð¸ÐºÐ°:", reply_markup=input_keyboard(include_back=False))[m
[36m@@ -362,6 +427,42 @@[m [masync def finalize_edit(message: Message, state: FSMContext) -> None:[m
 async def handle_start(message: Message, state: FSMContext) -> None:[m
     await state.clear()[m
     await message.answer("ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚:", reply_markup=main_keyboard)[m
[32m+[m[32m    if message.chat.type == "private" and message.from_user:[m
[32m+[m[32m        await send_start_report(message.bot, message.from_user)[m
[32m+[m
[32m+[m
[32m+[m[32m@router.message(Command("set_topic_starts"))[m
[32m+[m[32masync def handle_set_topic_starts(message: Message) -> None:[m
[32m+[m[32m    if not await ensure_topic_command(message):[m
[32m+[m[32m        return[m
[32m+[m
[32m+[m[32m    config = load_config()[m
[32m+[m[32m    config["report_chat_id"] = message.chat.id[m
[32m+[m[32m    config["starts_thread_id"] = message.message_thread_id[m
[32m+[m[32m    save_config(config)[m
[32m+[m
[32m+[m[32m    await message.bot.send_message([m
[32m+[m[32m        chat_id=message.chat.id,[m
[32m+[m[32m        message_thread_id=message.message_thread_id,[m
[32m+[m[32m        text="âœ… ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¾. Ð­Ñ‚Ð° Ñ‚ÐµÐ¼Ð° Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð° Ð´Ð»Ñ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð¾Ð² Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ….",[m
[32m+[m[32m    )[m
[32m+[m
[32m+[m
[32m+[m[32m@router.message(Command("set_topic_files"))[m
[32m+[m[32masync def handle_set_topic_files(message: Message) -> None:[m
[32m+[m[32m    if not await ensure_topic_command(message):[m
[32m+[m[32m        return[m
[32m+[m
[32m+[m[32m    config = load_config()[m
[32m+[m[32m    config["report_chat_id"] = message.chat.id[m
[32m+[m[32m    config["files_thread_id"] = message.message_thread_id[m
[32m+[m[32m    save_config(config)[m
[32m+[m
[32m+[m[32m    await message.bot.send_message([m
[32m+[m[32m        chat_id=message.chat.id,[m
[32m+[m[32m        message_thread_id=message.message_thread_id,[m
[32m+[m[32m        text="âœ… ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¾. Ð­Ñ‚Ð° Ñ‚ÐµÐ¼Ð° Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð° Ð´Ð»Ñ Ð°Ñ€Ñ…Ð¸Ð²Ð° Ñ„Ð°Ð¹Ð»Ð¾Ð².",[m
[32m+[m[32m    )[m
 [m
 [m
 @router.message(Command("cancel"))[m
[36m@@ -387,6 +488,8 @@[m [masync def start_contract_flow(message: Message, state: FSMContext) -> None:[m
     await state.update_data(doc_type="contract")[m
     await message.answer("Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¤Ð˜Ðž Ð·Ð°ÐºÐ°Ð·Ñ‡Ð¸ÐºÐ°:", reply_markup=input_keyboard(include_back=False))[m
     await state.set_state(ContractStates.waiting_for_client_name)[m
[32m+[m[32m    if message.from_user:[m
[32m+[m[32m        await send_doc_start_report(message.bot, message.from_user, DOC_TYPE_LABELS["contract"])[m
 [m
 [m
 @router.message(F.text == MAIN_MENU_ACT)[m
[36m@@ -395,6 +498,8 @@[m [masync def start_act_flow(message: Message, state: FSMContext) -> None:[m
     await state.update_data(doc_type="act")[m
     await message.answer("Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¤Ð˜Ðž Ð·Ð°ÐºÐ°Ð·Ñ‡Ð¸ÐºÐ°:", reply_markup=input_keyboard(include_back=False))[m
     await state.set_state(ContractStates.waiting_for_client_name)[m
[32m+[m[32m    if message.from_user:[m
[32m+[m[32m        await send_doc_start_report(message.bot, message.from_user, DOC_TYPE_LABELS["act"])[m
 [m
 [m
 @router.message(F.text == MAIN_MENU_SUPPLEMENT)[m
[36m@@ -403,6 +508,8 @@[m [masync def start_supplement_flow(message: Message, state: FSMContext) -> None:[m
     await state.update_data(doc_type="supplement", supplement_text="")[m
     await message.answer("Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð¼ÐµÑ€ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð°:", reply_markup=input_keyboard(include_back=False))[m
     await state.set_state(SupplementStates.waiting_for_contract_number)[m
[32m+[m[32m    if message.from_user:[m
[32m+[m[32m        await send_doc_start_report(message.bot, message.from_user, DOC_TYPE_LABELS["supplement"])[m
 [m
 [m
 @router.message(ContractStates.waiting_for_client_name)[m
[36m@@ -960,6 +1067,9 @@[m [masync def process_contract_confirm(message: Message, state: FSMContext) -> None:[m
     try:[m
         if result.pdf_path:[m
             await message.answer_document(FSInputFile(str(result.pdf_path)), caption=caption, reply_markup=main_keyboard)[m
[32m+[m[32m            if message.from_user:[m
[32m+[m[32m                report_caption = build_file_caption(data, message.from_user)[m
[32m+[m[32m                await send_file_report(message.bot, result.pdf_path, report_caption)[m
         else:[m
             await message.answer([m
                 f"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÐºÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð² PDF. ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑŽ DOCX.\nÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð°: {result.error}",[m
[36m@@ -1083,6 +1193,9 @@[m [masync def process_supplement_confirm(message: Message, state: FSMContext) -> Non[m
                 caption="Ð“Ð¾Ñ‚Ð¾Ð²Ð¾Ðµ Ð´Ð¾Ð¿. ÑÐ¾Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ðµ.",[m
                 reply_markup=main_keyboard,[m
             )[m
[32m+[m[32m            if message.from_user:[m
[32m+[m[32m                report_caption = build_file_caption(data, message.from_user)[m
[32m+[m[32m                await send_file_report(message.bot, result.pdf_path, report_caption)[m
         else:[m
             await message.answer([m
                 f"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÐºÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð² PDF. ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑŽ DOCX.\nÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð°: {result.error}",[m
[1mdiff --git a/src/main.py b/src/main.py[m
[1mindex bd52e3e..a553d18 100644[m
[1m--- a/src/main.py[m
[1m+++ b/src/main.py[m
[36m@@ -1,12 +1,15 @@[m
 import asyncio[m
[32m+[m[32mimport logging[m
 import os[m
 [m
 from aiogram import Bot, Dispatcher[m
 from dotenv import load_dotenv[m
 [m
 try:[m
[32m+[m[32m    from .config import load_config[m
     from .handlers import router[m
 except ImportError:  # pragma: no cover - allow running as a script[m
[32m+[m[32m    from config import load_config[m
     from handlers import router[m
 [m
 [m
[36m@@ -19,6 +22,17 @@[m [mdef get_bot_token() -> str:[m
 [m
 [m
 async def main() -> None:[m
[32m+[m[32m    logging.basicConfig([m
[32m+[m[32m        level=logging.INFO,[m
[32m+[m[32m        format="%(asctime)s | %(levelname)s | %(name)s | %(message)s",[m
[32m+[m[32m    )[m
[32m+[m[32m    config = load_config()[m
[32m+[m[32m    logging.getLogger(__name__).info([m
[32m+[m[32m        "Loaded report config: report_chat_id=%s starts_thread_id=%s files_thread_id=%s",[m
[32m+[m[32m        config.get("report_chat_id"),[m
[32m+[m[32m        config.get("starts_thread_id"),[m
[32m+[m[32m        config.get("files_thread_id"),[m
[32m+[m[32m    )[m
     bot = Bot(token=get_bot_token())[m
     dp = Dispatcher()[m
     dp.include_router(router)[m
